# エラーハンドリングポリシー

## 原則

- エラー発生時はまず原因を特定し、自動リカバリを試みる
- 自動リカバリに失敗した場合、ユーザーに状況と選択肢を提示する
- 同じエラーを3回以上リトライしない

## Git 操作のエラー

| エラー | 原因 | 対処 |
|---|---|---|
| `git push` rejected | リモートに新しいコミットがある | `git pull --rebase origin <branch>` → 再 push |
| `git worktree add` 失敗 | worktree またはブランチが既存 | `git worktree list` で確認 → 不要なら `git worktree remove` → リトライ |
| `git branch` 既存 | 同名ブランチが存在 | `git branch -l` で確認 → 不要なら `git branch -D` → リトライ |
| `git merge` コンフリクト | ファイルの競合 | `wf-resolve-conflict` スキルで解消 |
| `git checkout` 失敗 | 未コミットの変更がある | `git stash` → checkout → `git stash pop` |

## GitHub API のエラー（推奨: GitHub を使用する場合）

| エラー | 原因 | 対処 |
|---|---|---|
| PR 作成 409 | 同名 PR が既に存在 | 既存 PR を検索して再利用 |
| PR 作成 422 | head ブランチがリモートにない | `git push origin <branch>` → リトライ |
| マージ 405 | コンフリクトあり | `wf-resolve-conflict` スキルで解消 → リトライ |
| マージ 405 | レビュー承認が必要 | ユーザーに報告（リポジトリの保護ルール） |
| API レート制限 | リクエスト過多 | 30秒待機 → リトライ |

## Issue トラッカーのエラー（オプション: 使用する場合のみ）

| エラー | 原因 | 対処 |
|---|---|---|
| MCP ツール呼び出し失敗 | サーバー未起動 or 接続エラー | ユーザーに MCP サーバーの状態確認を依頼 |
| Issue 作成失敗 | 権限不足 or パラメータ不正 | エラーメッセージを確認し、パラメータを修正 → リトライ |
| Issue 更新失敗 | ID が不正 | `identifier` ではなく `id`（UUID）を使用しているか確認 |

## リトライポリシー

1. 最大3回までリトライする
2. リトライ間隔: 即時 → 5秒 → 30秒
3. 3回失敗したらユーザーに報告し、手動対応を依頼する

## 報告形式

自動リカバリできなかった場合、以下の形式で報告する:

```markdown
## ⚠️ エラー発生

- **操作**: <実行しようとした操作>
- **エラー**: <エラーメッセージ>
- **試行**: <リトライ回数> / 3
- **推奨対処**: <ユーザーが取るべきアクション>
```
